<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 9. 25.     	김주민            최초 생성
 *	2025. 9. 29.		김주민			selectTotalRecord, selectProjectList
 *										,selectMyProjectList(페이징) 추가
 *	2025. 9. 30. 		김주민 			selectProject 쿼리에 user_nm 추가
 *	2025. 10. 01.		김주민			보관함 조회 selectArchivedProjectList,	selectArchivedTotalRecord 추가
 *	2025. 10. 10. 		김주민			프로젝트 진행률 쿼리 추가
 *	2025. 10. 11.		김주민			프로젝트 완료 처리 completeProject 추가
 *  2025. 10. 13.		김주민			검색을 위한 코드조각 추가
 *	2025. 10. 21.		김주민			관리자 페이지 취소복원을 위한
 *
-->
<mapper namespace="kr.or.ddit.mybatis.mapper.ProjectMapper">

<!-- 프로젝트 상태 수정 -->
<update id="updateProjectStatus" parameterType="kr.or.ddit.vo.ProjectVO">
	UPDATE PROJECT
	SET BIZ_STTS_CD = 'B302'
	WHERE BIZ_ID = #{bizId}
</update>

<sql id="fromFrag">
    FROM PROJECT p
    INNER JOIN COMMON_CODE ccs
        ON p.BIZ_STTS_CD = ccs.CODE_ID
        AND ccs.CODE_GRP_ID = 'B3'
    INNER JOIN COMMON_CODE cct
        ON p.BIZ_TYPE_CD = cct.CODE_ID
        AND cct.CODE_GRP_ID = 'B2'
    LEFT JOIN USERS u
        ON p.BIZ_PIC_ID = u.USER_ID
    LEFT JOIN DEPARTMENT d
        ON u.DEPT_ID = d.DEPT_ID
    LEFT JOIN JOB_GRADE jg
        ON u.JBGD_CD = jg.JBGD_CD
    LEFT JOIN FILE_DETAIL f
    ON u.USER_IMG_FILE_ID = f.FILE_ID
</sql>

<!-- SimpleSearch 검색 조각 -->
<sql id="simpleSearchFrag">
    <if test="simpleSearch neq null">
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(simpleSearch.searchWord)">
            AND (
                <choose>
                    <when test="simpleSearch.searchType eq 'projectName'">
                        p.BIZ_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                    </when>
                    <when test="simpleSearch.searchType eq 'managerName'">
                        u.USER_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                    </when>
                    <otherwise>
                        p.BIZ_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                        OR
                        u.USER_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                    </otherwise>
                </choose>
            )
        </if>
    </if>
</sql>

<!-- DetailSearch 검색 조각 -->
<sql id="detailSearchFrag">
    <if test="detailSearch != null">
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(detailSearch.bizSttsCd)">
            AND p.BIZ_STTS_CD = #{detailSearch.bizSttsCd}
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(detailSearch.searchStrtBizDt)">
            AND TRUNC(p.STRT_BIZ_DT) >= TO_DATE(#{detailSearch.searchStrtBizDt}, 'YYYY-MM-DD')
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(detailSearch.searchEndBizDt)">
            AND TRUNC(p.END_BIZ_DT) <![CDATA[<=]]> TO_DATE(#{detailSearch.searchEndBizDt}, 'YYYY-MM-DD')
        </if>
    </if>
</sql>

<!-- 전체 레코드 수 조회 -->
<select id="selectTotalRecord" resultType="int">
    SELECT COUNT(*)
    <include refid="fromFrag" />
    WHERE ccs.USE_YN = 'Y'
        AND p.BIZ_STTS_CD != 'B305'
        <include refid="simpleSearchFrag" />
        <include refid="detailSearchFrag" />
</select>

<!-- 프로젝트 목록 조회 (페이징) -->
<select id="selectProjectList" resultType="kr.or.ddit.vo.ProjectVO">
    SELECT B.*
    FROM (
        SELECT ROWNUM RNUM, A.*
        FROM (
            SELECT
                p.BIZ_ID
                , p.BIZ_NM
                , p.BIZ_PIC_ID
                , u.USER_NM AS BIZ_PIC_NM
                , jg.JBGD_NM AS BIZ_USER_JOB_NM
                , d.DEPT_NM AS BIZ_PIC_DEPT_NM
                , cct.CODE_NM AS BIZ_TYPE_NM
                , ccs.CODE_NM AS BIZ_STTS_CD
                , p.BIZ_GOAL
                , p.BIZ_DETAIL
                , p.BIZ_SCOPE
                , p.BIZ_BDGT
                , p.BIZ_PRGRS
                , p.STRT_BIZ_DT
                , p.END_BIZ_DT
                , p.BIZ_FILE_ID
                , f.FILE_PATH
            <include refid="fromFrag" />
            WHERE ccs.USE_YN = 'Y'
                AND p.BIZ_STTS_CD != 'B305'
                <include refid="simpleSearchFrag" />
                <include refid="detailSearchFrag" />
            ORDER BY p.STRT_BIZ_DT DESC
        ) A
    ) B
    <![CDATA[
        WHERE RNUM >= #{startRow} AND RNUM <= #{endRow}
    ]]>
</select>

<!-- 프로젝트 완료 처리(프로젝트 상태 변경) -->
<update id="completeProject">
	UPDATE PROJECT
	SET BIZ_STTS_CD = 'B304'
	WHERE BIZ_ID = #{bizId}
		AND BIZ_STTS_CD IN ('B302', 'B303')
</update>

<!-- 프로젝트 진행률 업데이트 -->
<update id="updateProjectProgress">
	UPDATE PROJECT
	SET BIZ_PRGRS = (
		SELECT
			NVL(ROUND(AVG(
				NVL(
					ROUND(
						(SELECT COUNT(*)
						 FROM TASK_CHECKLIST
						 WHERE TASK_ID = MT.TASK_ID
						 AND COMPLT_YN = 'Y') * 100.0 /
						NULLIF((SELECT COUNT(*)
								FROM TASK_CHECKLIST
								WHERE TASK_ID = MT.TASK_ID), 0)
					), 0
				)
			)), 0)
		FROM MAIN_TASK MT
		WHERE MT.BIZ_ID = #{bizId}
			AND MT.TASK_STTS_CD != 'B405'
	)
	WHERE BIZ_ID = #{bizId}
</update>

<!-- 프로젝트 진행률 조회 (업무 평균 진행률) -->
<select id="selectProjectProgress" resultType="Integer">
	SELECT
        NVL(ROUND(AVG(
            NVL(
                ROUND(
                    (SELECT COUNT(*)
                     FROM TASK_CHECKLIST
                     WHERE TASK_ID = MT.TASK_ID
                     AND COMPLT_YN = 'Y') * 100.0 /
                    NULLIF((SELECT COUNT(*)
                            FROM TASK_CHECKLIST
                            WHERE TASK_ID = MT.TASK_ID), 0)
                ), 0
            )
        )), 0) AS BIZ_PRGRS
    FROM MAIN_TASK MT
    WHERE MT.BIZ_ID = #{bizId}
      AND MT.TASK_STTS_CD != 'B405'
</select>

<!-- 보관함 검색용 SQL 조각 (상태 제외) -->
<sql id="archiveSearchFrag">
    <if test="simpleSearch neq null">
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(simpleSearch.searchWord)">
            AND (
                <choose>
                    <when test="simpleSearch.searchType eq 'projectName'">
                        p.BIZ_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                    </when>
                    <when test="simpleSearch.searchType eq 'managerName'">
                        u.USER_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                    </when>
                    <otherwise>
                        p.BIZ_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                        OR
                        u.USER_NM LIKE '%' || #{simpleSearch.searchWord} || '%'
                    </otherwise>
                </choose>
            )
        </if>
    </if>

    <!-- 기간 검색 (DetailSearch) -->
    <if test="detailSearch != null">
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(detailSearch.searchStrtBizDt)">
            AND TRUNC(p.STRT_BIZ_DT) >= TO_DATE(#{detailSearch.searchStrtBizDt}, 'YYYY-MM-DD')
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(detailSearch.searchEndBizDt)">
            AND TRUNC(p.END_BIZ_DT) <![CDATA[<=]]> TO_DATE(#{detailSearch.searchEndBizDt}, 'YYYY-MM-DD')
        </if>
    </if>
</sql>

<!-- 보관함 전체 레코드 수 -->
<select id="selectArchivedTotalRecord" resultType="int">
    SELECT COUNT(*)
    FROM PROJECT p
    LEFT JOIN USERS u
        ON p.BIZ_PIC_ID = u.USER_ID
    LEFT JOIN DEPARTMENT d  ON u.DEPT_ID = d.DEPT_ID
    LEFT JOIN JOB_GRADE jg  ON u.JBGD_CD = jg.JBGD_CD
    WHERE p.BIZ_STTS_CD = 'B305'
    <include refid="archiveSearchFrag" />
</select>

<!-- 보관함 프로젝트 목록 조회 -->
<select id="selectArchivedProjectList" resultType="kr.or.ddit.vo.ProjectVO">
    WITH BASE_DATA AS (
        SELECT
            p.BIZ_ID
            , p.BIZ_NM
            , p.BIZ_PIC_ID
            , u.USER_NM AS BIZ_PIC_NM
            , jg.JBGD_NM AS BIZ_USER_JOB_NM
            , d.DEPT_NM AS BIZ_PIC_DEPT_NM
            , cct.CODE_NM AS BIZ_TYPE_NM
            , ccs.CODE_NM AS BIZ_STTS_CD
            , p.BIZ_GOAL
            , p.BIZ_DETAIL
            , p.BIZ_SCOPE
            , p.BIZ_BDGT
            , p.BIZ_PRGRS
            , p.STRT_BIZ_DT
            , p.END_BIZ_DT
            , p.BIZ_FILE_ID
        FROM PROJECT p
        INNER JOIN COMMON_CODE ccs
            ON p.BIZ_STTS_CD = ccs.CODE_ID
            AND ccs.CODE_GRP_ID = 'B3'
        INNER JOIN COMMON_CODE cct
            ON p.BIZ_TYPE_CD = cct.CODE_ID
            AND cct.CODE_GRP_ID = 'B2'
        LEFT JOIN USERS u
            ON p.BIZ_PIC_ID = u.USER_ID
        LEFT JOIN DEPARTMENT d          ON u.DEPT_ID = d.DEPT_ID
        LEFT JOIN JOB_GRADE jg          ON u.JBGD_CD = jg.JBGD_CD
        WHERE p.BIZ_STTS_CD = 'B305'
        <include refid="archiveSearchFrag" />
        ORDER BY p.STRT_BIZ_DT DESC
    ),
    MV AS (
        SELECT
            BASE_DATA.*,
            ROWNUM AS RNUM
        FROM BASE_DATA
    )
    SELECT
        MV.*
    FROM MV
    WHERE MV.RNUM BETWEEN #{startRow} AND #{endRow}
</select>

<!-- 현재는 '진행 중인 프로젝트'에 사용되고 있음. (프로젝트 상태 : 승인대기, 진행, 보류) -->
<select id="selectMyProjectTotalRecord" resultType="int">
	SELECT COUNT(DISTINCT p.BIZ_ID)
    FROM PROJECT p
    INNER JOIN COMMON_CODE cc
        ON p.BIZ_STTS_CD = cc.CODE_ID
        AND cc.CODE_GRP_ID = 'B3'
    WHERE cc.USE_YN = 'Y'
        AND p.BIZ_STTS_CD NOT IN ('B304', 'B305')
        AND (
            p.BIZ_PIC_ID = #{userId}
            OR EXISTS (
                SELECT 1
                FROM PROJECT_MEMBER pm
                WHERE pm.BIZ_ID = p.BIZ_ID
                AND pm.BIZ_USER_ID = #{userId}
                AND pm.BIZ_AUTH_CD IN ('B101', 'B102', 'B103')
            )
        )
</select>

<!-- 진행 중인 프로젝트 (프로젝트 상태 : 승인대기, 진행, 보류) -->
<select id="selectMyProjectList" resultType="kr.or.ddit.vo.ProjectVO">
SELECT *
FROM (
    SELECT
        ROWNUM RNUM, A.*
    FROM (
        SELECT DISTINCT
            p.BIZ_ID
            , p.BIZ_NM
            , p.BIZ_PIC_ID
            , u.USER_NM AS BIZ_PIC_NM
            , p.BIZ_TYPE_CD
            , cc.CODE_NM AS BIZ_STTS_CD
            , p.BIZ_GOAL
            , p.BIZ_BDGT
            , p.BIZ_PRGRS
            , p.STRT_BIZ_DT
            , p.END_BIZ_DT
            , p.BIZ_FILE_ID
        FROM PROJECT p
        INNER JOIN COMMON_CODE cc
            ON p.BIZ_STTS_CD = cc.CODE_ID
            AND cc.CODE_GRP_ID = 'B3'
        LEFT JOIN USERS u
            ON p.BIZ_PIC_ID = u.USER_ID
        WHERE cc.USE_YN = 'Y'
        AND p.BIZ_STTS_CD NOT IN ('B304', 'B305')
        AND (
            p.BIZ_PIC_ID = #{userId}
            OR EXISTS (
                SELECT 1
                FROM PROJECT_MEMBER pm
                WHERE pm.BIZ_ID = p.BIZ_ID
                AND pm.BIZ_USER_ID = #{userId}
                AND pm.BIZ_AUTH_CD IN ('B101', 'B102', 'B103')
            )
        )
        ORDER BY p.STRT_BIZ_DT DESC
    ) A
    WHERE ROWNUM &lt;= #{paging.endRow}
)
WHERE RNUM >= #{paging.startRow}
</select>

<!-- '진행한 프로젝트'에서 사용 -->
<select id="selectMyCompletedProjectTotalRecord" resultType="int">
	SELECT COUNT(DISTINCT p.BIZ_ID)
    FROM PROJECT p
    INNER JOIN COMMON_CODE cc
        ON p.BIZ_STTS_CD = cc.CODE_ID
        AND cc.CODE_GRP_ID = 'B3'
    WHERE cc.USE_YN = 'Y'
        AND p.BIZ_STTS_CD = 'B304'  AND (
            p.BIZ_PIC_ID = #{userId}
            OR EXISTS (
                SELECT 1
                FROM PROJECT_MEMBER pm
                WHERE pm.BIZ_ID = p.BIZ_ID
                AND pm.BIZ_USER_ID = #{userId}
                AND pm.BIZ_AUTH_CD IN ('B101', 'B102', 'B103')
            )
        )
</select>

<!-- 진행한 프로젝트 목록 조회(B304) -->
<select id="selectMyCompletedProjectList" resultType="kr.or.ddit.vo.ProjectVO">
	SELECT *
	FROM (
	    SELECT
	        ROWNUM RNUM, A.*
	    FROM (
	        SELECT DISTINCT
	            p.BIZ_ID
	            , p.BIZ_NM
	            , p.BIZ_PIC_ID
	            , u.USER_NM AS BIZ_PIC_NM
	            , p.BIZ_TYPE_CD
	            , cc.CODE_NM AS BIZ_STTS_CD
	            , p.BIZ_GOAL
	            , p.BIZ_BDGT
	            , p.BIZ_PRGRS
	            , p.STRT_BIZ_DT
	            , p.END_BIZ_DT
	            , p.BIZ_FILE_ID
	        FROM PROJECT p
	        INNER JOIN COMMON_CODE cc
	            ON p.BIZ_STTS_CD = cc.CODE_ID
	            AND cc.CODE_GRP_ID = 'B3'
	        LEFT JOIN USERS u
	            ON p.BIZ_PIC_ID = u.USER_ID
	        WHERE cc.USE_YN = 'Y'
	        AND p.BIZ_STTS_CD = 'B304'  AND (
	            p.BIZ_PIC_ID = #{userId}
	            OR EXISTS (
	                SELECT 1
	                FROM PROJECT_MEMBER pm
	                WHERE pm.BIZ_ID = p.BIZ_ID
	                AND pm.BIZ_USER_ID = #{userId}
	                AND pm.BIZ_AUTH_CD IN ('B101', 'B102', 'B103')
	            )
	        )
	        ORDER BY p.STRT_BIZ_DT DESC
	    ) A
	    WHERE ROWNUM &lt;= #{paging.endRow}
	)
	WHERE RNUM >= #{paging.startRow}
</select>


<!-- 프로젝트 등록 -->
<insert id="insertProject">
	<selectKey keyProperty="bizId" resultType="String" order="BEFORE">
		SELECT 'BIZ' || LPAD(BIZ_ID_SEQ.NEXTVAL, 9, 0) FROM DUAL
	</selectKey>
	INSERT INTO PROJECT (
		BIZ_ID
		, BIZ_NM
		, BIZ_PIC_ID
		, BIZ_TYPE_CD
		, BIZ_STTS_CD
		, BIZ_GOAL
		, BIZ_DETAIL
		, BIZ_SCOPE
		, BIZ_BDGT
		, BIZ_PRGRS
		, STRT_BIZ_DT
		, END_BIZ_DT
		, BIZ_FILE_ID
	) VALUES (
		#{bizId}
		, #{bizNm}
		, #{bizPicId}
		, #{bizTypeCd}
		, NVL(#{bizSttsCd}, 'B301')
		, #{bizGoal}
		, #{bizDetail}
		, #{bizScope}
		, #{bizBdgt}
		, #{bizPrgrs}
		, #{strtBizDt}
		, #{endBizDt}
		, #{bizFileId}
	)
</insert>

<!-- 전체 프로젝트 목록(페이징X) -->
<select id="selectProjectListNonPaging" resultType="kr.or.ddit.vo.ProjectVO">
	SELECT
		p.BIZ_ID
		, p.BIZ_NM
		, u.USER_NM AS BIZ_PIC_ID
		, p.BIZ_TYPE_CD
		, t.CODE_NM AS BIZ_TYPE_NM
		, cc.CODE_NM AS BIZ_STTS_CD
		, p.BIZ_GOAL
		, p.BIZ_DETAIL
		, p.BIZ_SCOPE
		, p.BIZ_BDGT
		, p.BIZ_PRGRS
		, p.STRT_BIZ_DT
		, p.END_BIZ_DT
		, p.BIZ_FILE_ID
	FROM PROJECT p
	INNER JOIN COMMON_CODE cc
		ON p.BIZ_STTS_CD = cc.CODE_ID
		AND cc.CODE_GRP_ID = 'B3'
    LEFT JOIN COMMON_CODE t
        ON p.BIZ_TYPE_CD = t.CODE_ID
        AND t.CODE_GRP_ID = 'B2'
	LEFT JOIN USERS u
		ON p.BIZ_PIC_ID = u.USER_ID
	WHERE cc.USE_YN = 'Y'
	ORDER BY p.STRT_BIZ_DT DESC
</select>

<select id="selectMyProjectListNonPaging" resultType="kr.or.ddit.vo.ProjectVO">
	SELECT DISTINCT
		p.BIZ_ID
		, p.BIZ_NM
		, u.USER_NM AS BIZ_PIC_ID
		, p.BIZ_TYPE_CD
		, cc.CODE_NM AS BIZ_STTS_CD
		, p.BIZ_GOAL
		, p.BIZ_BDGT
		, p.BIZ_PRGRS
		, p.STRT_BIZ_DT
		, p.END_BIZ_DT
		, p.BIZ_FILE_ID
	FROM PROJECT p
	INNER JOIN COMMON_CODE cc
		ON p.BIZ_STTS_CD = cc.CODE_ID
		AND cc.CODE_GRP_ID = 'B3'
	LEFT JOIN USERS u
		ON p.BIZ_PIC_ID = u.USER_ID
	LEFT JOIN PROJECT_MEMBER pm
		ON p.BIZ_ID = pm.BIZ_ID
	WHERE cc.USE_YN = 'Y'
        AND (
            p.BIZ_PIC_ID = #{userId}
            OR pm.BIZ_USER_ID = #{userId}
        )
    ORDER BY p.STRT_BIZ_DT DESC

</select>

<!-- 프로젝트 단건 조회 -->
<select id="selectProject" resultType="kr.or.ddit.vo.ProjectVO">
	SELECT
		p.BIZ_ID
		, p.BIZ_NM
		, p.BIZ_PIC_ID
		, u.USER_NM AS BIZ_PIC_NM
		, d.DEPT_NM AS BIZ_PIC_DEPT_NM
		, jg.JBGD_NM AS BIZ_USER_JOB_NM  , cct.CODE_NM AS BIZ_TYPE_CD
		, ccs.CODE_NM AS BIZ_STTS_CD
		, p.BIZ_GOAL
		, p.BIZ_DETAIL
		, p.BIZ_SCOPE
		, p.BIZ_BDGT
		, p.BIZ_PRGRS
		, p.STRT_BIZ_DT
		, p.END_BIZ_DT
		, p.BIZ_FILE_ID
	FROM PROJECT p
	INNER JOIN COMMON_CODE ccs
		ON p.BIZ_STTS_CD = ccs.CODE_ID
		AND ccs.CODE_GRP_ID = 'B3'
	INNER JOIN COMMON_CODE cct
		ON p.BIZ_TYPE_CD = cct.CODE_ID
		AND cct.CODE_GRP_ID = 'B2'
	LEFT JOIN USERS u
		ON p.BIZ_PIC_ID = u.USER_ID
	LEFT JOIN DEPARTMENT d
		ON u.DEPT_ID = d.DEPT_ID
	LEFT JOIN JOB_GRADE jg  ON u.JBGD_CD = jg.JBGD_CD
	WHERE p.BIZ_ID = #{bizId}
</select>

<update id="updateProject">
	UPDATE PROJECT
	<set> BIZ_NM = #{bizNm},
		BIZ_TYPE_CD = #{bizTypeCd},
		BIZ_STTS_CD = #{bizSttsCd},
		BIZ_GOAL = #{bizGoal},
		BIZ_DETAIL = #{bizDetail},
		BIZ_SCOPE = #{bizScope},
		BIZ_BDGT = #{bizBdgt},
		BIZ_PRGRS = #{bizPrgrs},
		STRT_BIZ_DT = #{strtBizDt},
		END_BIZ_DT = #{endBizDt},

		<if test="bizFileId != null and bizFileId != ''">
		BIZ_FILE_ID = #{bizFileId},
		</if>
	</set> WHERE BIZ_ID = #{bizId}
</update>

<update id="deleteProject">
	UPDATE PROJECT
	SET BIZ_STTS_CD = 'B305'
	WHERE BIZ_ID = #{bizId}
		AND BIZ_STTS_CD IN ('B301','B302', 'B303')
</update>

</mapper>