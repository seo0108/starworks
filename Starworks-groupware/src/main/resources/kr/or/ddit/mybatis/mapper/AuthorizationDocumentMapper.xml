<?xml version="1.0" encoding="UTF-8"?>
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 9. 25.     	윤서현            최초 생성
 * 	2025. 9. 30.		홍현택			전자결재 로그인한 사용자의 목록 조회
 *  2025.10.  1. 		임가영			주석 추가
 *	2025.10.  4.		임가영			updateAuthorizationDocument(기안서 업데이트) 쿼리 추가
 *	2025.10. 10.		홍현택 			updateDocumentStatusAndDelYn 삭제여부 Y 로 변경 쿼리 추가, 문서상태도 임시저장으로 변경.
 *	2025.10. 10.		홍현택			목록 조회 메서드에 페이징 검색 추가
 *	2025. 10. 20.		임가영			selectMyAllCombined 쿼리 수정 (결재선까지 가져오도록)
 *	2025. 10. 23.		홍현택			selectAuthDocument 쿼리 수정
 *	2025. 10. 25.		홍현택			보안레벨에 따른 권한 제어를 위해 ADT.ATRZ_SECURE_LVL 추가
 *
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mybatis.mapper.AuthorizationDocumentMapper">
<!-- (가영 생성) resultMap / 문서 기본키(그룹핑 기준이 되는 PK) -->
<resultMap type="kr.or.ddit.vo.AuthorizationDocumentVO" id="authorizationDocumentMap" autoMapping="true">
	<id property="atrzDocId" column="ATRZ_DOC_ID"/>
	<result property="atrzSecureLvl" column="ATRZ_SECURE_LVL"/>
	<association property="users" javaType="kr.or.ddit.vo.UsersVO" autoMapping="true"></association>

	<collection property="approvalLines" ofType="kr.or.ddit.vo.AuthorizationLineVO" autoMapping="true">
		<id property="atrzLineSeq" column="ATRZ_LINE_SQN"/>
	</collection>
</resultMap>

	<insert id="insertAuthDocument">
<!-- 		<selectKey keyProperty="atrzDocId" resultType="String" order="BEFORE"> -->
<!-- 	        SELECT 'ATRZ' || LPAD(ATRZ_DOC_ID_SEQ.NEXTVAL, 12, '0') FROM dual -->
<!-- 	    </selectKey> -->

		INSERT INTO AUTHORIZATION_DOCUMENT(
			ATRZ_DOC_ID
			, ATRZ_DOC_TMPL_ID
			, ATRZ_DOC_TTL
			, CRNT_ATRZ_STEP_CD
			, HTML_DATA
			, ATRZ_USER_ID
			, ATRZ_FILE_ID
		)VALUES(
			 #{atrzDocId}
			 ,#{atrzDocTmplId}
			 ,#{atrzDocTtl}
			 , 'A202'
			 ,#{htmlData}
			 ,#{atrzUserId}
			 ,#{atrzFileId}
		)
	</insert>

	<!-- 다음 결재 문서번호 시퀀스 조회 -->
	<select id="getNextDocId" resultType="string">
	    SELECT 'ATRZ' || LPAD(ATRZ_DOC_ID_SEQ.NEXTVAL, 12, '0') AS DOC_ID
	    FROM DUAL
	</select>

	<!-- 삭제 되지 않은 모든 기안 문서 조회 -->
	<select id="selectAuthDocumentList" resultType="kr.or.ddit.vo.AuthorizationDocumentVO">
		  SELECT
		      AD.ATRZ_DOC_ID             AS atrzDocId,
		      AD.ATRZ_DOC_TTL            AS atrzDocTtl,
		      CAST(AD.ATRZ_SBMT_DT AS TIMESTAMP) AS atrzSbmtDt,
		      ADT.ATRZ_DOC_TMPL_NM       AS atrzDocTmplNm,
		      U.USER_NM                  AS drafterName,
		      CC.CODE_NM                 AS crntAtrzStepNm
		  FROM
		  TEAM1_202504F.AUTHORIZATION_DOCUMENT AD
		  JOIN TEAM1_202504F.AUTHORIZATION_DOCUMENT_TEMPLATE ADT
		    ON AD.ATRZ_DOC_TMPL_ID = ADT.ATRZ_DOC_TMPL_ID
		  JOIN TEAM1_202504F.USERS U
		    ON AD.ATRZ_USER_ID = U.USER_ID
		  LEFT JOIN TEAM1_202504F.COMMON_CODE CC
		    ON CC.CODE_ID = AD.CRNT_ATRZ_STEP_CD
		  WHERE
		  AD.DEL_YN = 'N'
		  ORDER BY
		  AD.ATRZ_SBMT_DT DESC, AD.ATRZ_DOC_ID DESC
	</select>


	<!-- ============기안문서 상세 조회============== -->
		<select id="selectAuthDocument" parameterType="string" resultType="kr.or.ddit.vo.AuthorizationDocumentVO">
		    SELECT
		          d.ATRZ_DOC_ID
		        ,d.ATRZ_DOC_TMPL_ID
		        ,d.ATRZ_DOC_TTL
		        ,d.ATRZ_SBMT_DT
		        ,d.CRNT_ATRZ_STEP_CD
		        ,d.DEL_YN
		        ,d.HTML_DATA
		        ,d.OPEN_YN
		        ,d.ATRZ_USER_ID
		        ,d.ATRZ_FILE_ID
		        ,t.ATRZ_DOC_TMPL_NM   AS atrzDocTmplNm
		        ,t.ATRZ_SECURE_LVL
		        ,u.USER_NM            AS drafterName
		        ,j.JBGD_NM			  AS drafterJbgdNm
		        ,dp.DEPT_NM			  AS drafterDeptNm
				,fd.FILE_PATH		  AS drafterFilePath
		        ,cc.CODE_NM           AS crntAtrzStepNm
		    FROM
		    AUTHORIZATION_DOCUMENT d
		    JOIN
		    AUTHORIZATION_DOCUMENT_TEMPLATE t
		      ON t.ATRZ_DOC_TMPL_ID = d.ATRZ_DOC_TMPL_ID
		    JOIN USERS u
		      ON u.USER_ID = d.ATRZ_USER_ID
			LEFT JOIN JOB_GRADE j
			  ON u.JBGD_CD = j.JBGD_CD
			LEFT JOIN DEPARTMENT dp
			  ON u.DEPT_ID = dp.DEPT_ID
		    LEFT JOIN FILE_DETAIL fd
		      ON u.USER_IMG_FILE_ID = fd.FILE_ID
		    LEFT JOIN COMMON_CODE cc
		      ON cc.CODE_ID = d.CRNT_ATRZ_STEP_CD
		    WHERE
		    	d.ATRZ_DOC_ID = #{atrzDocId}
		</select>

	<update id="updateAuthDocument">
		UPDATE AUTHORIZATION_DOCUMENT
		SET
			DEL_YN = 'Y'
		WHERE ATRZ_DOC_ID=#{atrzDocId}
	</update>

	<!-- ===================== 전자결재 보관함 시작 ===================== -->
	<!-- 전자결재 보관함 검색 sql 조각 -->
	<sql id="authorizationDocumentSimpleSearchFrag">
		<trim prefix="AND">
			<!-- 문서 종류 조건은 항상 동일하게 처리 -->
	        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(authorizationDocument.atrzDocTmplId)">
	            AD.ATRZ_DOC_TMPL_ID = #{authorizationDocument.atrzDocTmplId}
	        </if>
	     </trim>

	        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchWord)">
		        <choose>
		            <when test='paging.simpleSearch.searchType eq "title"'>
		                AND ATRZ_DOC_TTL LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
		            </when>
		            <when test='paging.simpleSearch.searchType eq "writer"'>
		                AND U.USER_NM LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
		            </when>
		            <otherwise>
		                AND (ATRZ_DOC_TTL LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
			                 OR
			                 U.USER_NM LIKE '%' || #{paging.simpleSearch.searchWord} || '%')
		            </otherwise>
		        </choose>
	        </if>
	</sql>

	<!-- 기안자 Id 의 결재 문서중 , 현재 결재 단계 코드 : 최종결재 인 List 조회 (페이징 X) -->
	<select id="selectAuthorizationDocumentListUserNonPaging" resultType="kr.or.ddit.vo.AuthorizationDocumentVO" resultMap="authorizationDocumentMap">
		SELECT
				AD.ATRZ_DOC_ID
				, AD.ATRZ_DOC_TMPL_ID
				, AD.ATRZ_DOC_TTL
				, AD.ATRZ_SBMT_DT
				, AD.CRNT_ATRZ_STEP_CD
				, AD.DEL_YN
				, AD.OPEN_YN
				, AD.ATRZ_USER_ID
				, AD.ATRZ_FILE_ID
				, C.CODE_NM	as crntAtrzStepNm
				, U.USER_NM
				, ADT.ATRZ_DOC_TMPL_NM
			FROM
				AUTHORIZATION_DOCUMENT AD
			LEFT OUTER JOIN
				USERS U
				ON AD.ATRZ_USER_ID = U.USER_ID
			LEFT OUTER JOIN
				COMMON_CODE C
				ON AD.CRNT_ATRZ_STEP_CD = C.CODE_ID
			LEFT OUTER JOIN
				AUTHORIZATION_DOCUMENT_TEMPLATE ADT
				ON AD.ATRZ_DOC_TMPL_ID = ADT.ATRZ_DOC_TMPL_ID
			WHERE
				ATRZ_USER_ID = #{atrzUserId}
			AND
				CRNT_ATRZ_STEP_CD = 'A206'
			ORDER BY
				ATRZ_SBMT_DT DESC
	</select>

	<!-- 기안자 Id 의 결재 문서중 , 현재 결재 단계 코드 : 최종결재 인 List 조회 (페이징 O) -->
	<select id="selectAuthorizationDocumentListUser" resultType="kr.or.ddit.vo.AuthorizationDocumentVO" resultMap="authorizationDocumentMap">
		SELECT *
		FROM ( SELECT ROWNUM as RNUM, ADV.*
				      FROM  (SELECT
							AD.ATRZ_DOC_ID
							, AD.ATRZ_DOC_TMPL_ID
							, AD.ATRZ_DOC_TTL
							, AD.ATRZ_SBMT_DT
							, AD.CRNT_ATRZ_STEP_CD
							, AD.DEL_YN
							, AD.OPEN_YN
							, AD.ATRZ_USER_ID
							, AD.ATRZ_FILE_ID
							, C.CODE_NM	as crntAtrzStepNm
							, U.USER_NM
							, ADT.ATRZ_DOC_TMPL_NM
							, ADT.ATRZ_SECURE_LVL
						FROM
							AUTHORIZATION_DOCUMENT AD
						LEFT OUTER JOIN
							USERS U
							ON AD.ATRZ_USER_ID = U.USER_ID
						LEFT OUTER JOIN
							COMMON_CODE C
							ON AD.CRNT_ATRZ_STEP_CD = C.CODE_ID
						LEFT OUTER JOIN
							AUTHORIZATION_DOCUMENT_TEMPLATE ADT
							ON AD.ATRZ_DOC_TMPL_ID = ADT.ATRZ_DOC_TMPL_ID
						WHERE
							ATRZ_USER_ID = #{authorizationDocument.atrzUserId}
					AND
						CRNT_ATRZ_STEP_CD = 'A206'
						<include refid="authorizationDocumentSimpleSearchFrag" />
					ORDER BY
						ATRZ_SBMT_DT DESC ) ADV )
		WHERE
			RNUM BETWEEN #{paging.startRow} AND #{paging.endRow}
	</select>

	<!-- 사용자 부서의, 현재 결재 단계 코드 : 최종결재 인 List 조회 (페이징 X) -->
	<select id="selectAuthorizationDocumentListDepartNonPaging" resultType="kr.or.ddit.vo.AuthorizationDocumentVO" resultMap="authorizationDocumentMap">
		SELECT
		AD.ATRZ_DOC_ID
            , AD.ATRZ_DOC_TMPL_ID
            , AD.ATRZ_DOC_TTL
            , AD.ATRZ_SBMT_DT
            , AD.CRNT_ATRZ_STEP_CD
            , AD.DEL_YN
            , AD.OPEN_YN
            , AD.ATRZ_USER_ID
            , AD.ATRZ_FILE_ID
            , C.CODE_NM	as crntAtrzStepNm
            , U.USER_NM
            , ADT.ATRZ_DOC_TMPL_NM
		from
			AUTHORIZATION_DOCUMENT AD
		LEFT OUTER JOIN
				USERS U
				ON AD.ATRZ_USER_ID = U.USER_ID
        LEFT OUTER JOIN
            COMMON_CODE C
            ON AD.CRNT_ATRZ_STEP_CD = C.CODE_ID
        LEFT OUTER JOIN
            AUTHORIZATION_DOCUMENT_TEMPLATE ADT
            ON AD.ATRZ_DOC_TMPL_ID = ADT.ATRZ_DOC_TMPL_ID
        INNER JOIN
            (SELECT DEPT_ID
              FROM DEPARTMENT
              START WITH DEPT_ID = (select dept_id
		                      from users
		                     where USER_ID = #{atrzUserId})
              CONNECT BY PRIOR DEPT_ID = UP_DEPT_ID
            )D
                ON U.DEPT_ID = D.DEPT_ID
		AND
            AD.CRNT_ATRZ_STEP_CD = 'A206'
        ORDER BY
        	ATRZ_SBMT_DT DESC
	</select>

	<!-- 사용자 부서의, 현재 결재 단계 코드 : 최종결재 인 List 조회 (페이징 O) -->
	<select id="selectAuthorizationDocumentListDepart" resultType="kr.or.ddit.vo.AuthorizationDocumentVO" resultMap="authorizationDocumentMap">
	SELECT *
	FROM ( SELECT ROWNUM as RNUM, ADV.*
		      FROM  ( SELECT
						AD.ATRZ_DOC_ID
			            , AD.ATRZ_DOC_TMPL_ID
			            , AD.ATRZ_DOC_TTL
			            , AD.ATRZ_SBMT_DT
			            , AD.CRNT_ATRZ_STEP_CD
			            , AD.DEL_YN
			            , AD.OPEN_YN
			            , AD.ATRZ_USER_ID
			            , AD.ATRZ_FILE_ID
			            , C.CODE_NM	as crntAtrzStepNm
			            , U.USER_NM
			            , ADT.ATRZ_DOC_TMPL_NM
			            , ADT.ATRZ_SECURE_LVL
			            , CASE
		                    WHEN AD.ATRZ_USER_ID = #{authorizationDocument.atrzUserId} THEN 1
		                    WHEN EXISTS (
		                        SELECT 1
		                        FROM AUTHORIZATION_LINE AL
		                        WHERE AL.ATRZ_DOC_ID = AD.ATRZ_DOC_ID
		                          AND AL.ATRZ_APPR_USER_ID = #{authorizationDocument.atrzUserId}
		                    ) THEN 1
		                    ELSE 0
		                  END as accessAllowed
						from
							AUTHORIZATION_DOCUMENT AD
						LEFT OUTER JOIN
								USERS U
								ON AD.ATRZ_USER_ID = U.USER_ID
				        LEFT OUTER JOIN
				            COMMON_CODE C
				            ON AD.CRNT_ATRZ_STEP_CD = C.CODE_ID
				        LEFT OUTER JOIN
				            AUTHORIZATION_DOCUMENT_TEMPLATE ADT
				            ON AD.ATRZ_DOC_TMPL_ID = ADT.ATRZ_DOC_TMPL_ID
				        INNER JOIN
				            (SELECT DEPT_ID
				              FROM DEPARTMENT
				              START WITH DEPT_ID = (select dept_id
							                      from users
							                     where USER_ID = #{authorizationDocument.atrzUserId})
				              CONNECT BY PRIOR DEPT_ID = UP_DEPT_ID
				            )D
				                ON U.DEPT_ID = D.DEPT_ID
						AND
				            AD.CRNT_ATRZ_STEP_CD = 'A206'
					<include refid="authorizationDocumentSimpleSearchFrag" />
					ORDER BY
						ATRZ_SBMT_DT DESC ) ADV)
			WHERE RNUM BETWEEN #{paging.startRow} AND #{paging.endRow}
		</select>
	<!-- ===================== 전자결재 보관함 끝 ===================== -->

<!-- =================================로그인한 사용자의 전자결재 관련================================================ -->

	<!-- 검색 조건 (키워드) -->
	<sql id="myApprovalSearchFrag">
	    <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchWord)">
	        <choose>
	            <when test='paging.simpleSearch.searchType eq "title"'>
	                AND d.ATRZ_DOC_TTL LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
	            </when>
	            <when test='paging.simpleSearch.searchType eq "writer"'>
	                AND u.USER_NM LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
	            </when>
	            <otherwise>
	                AND (
	                    d.ATRZ_DOC_TTL LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
	                    OR u.USER_NM LIKE '%' || #{paging.simpleSearch.searchWord} || '%'
	                )
	            </otherwise>
	        </choose>
	    </if>
	</sql>

	<!-- 페이징 쿼리 -->
	<sql id="pagingHeader">
	    SELECT A.* FROM (
	        SELECT ROWNUM RNUM, B.* FROM (
	</sql>
	<sql id="pagingFooter">
	        ) B
	    ) A
	    WHERE RNUM BETWEEN #{paging.startRow} AND #{paging.endRow}
	</sql>

	<!-- ========================나의 기안 문서================================== -->
	<select id="countMyDraftList" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM AUTHORIZATION_DOCUMENT d
        JOIN USERS u ON u.USER_ID = d.ATRZ_USER_ID
        WHERE d.ATRZ_USER_ID = #{userId}
          AND NVL(d.DEL_YN,'N') = 'N'
        <include refid="myApprovalSearchFrag" />
        <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
            AND d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus}
        </if>
    </select>

    <!-- 나의 기안 문서 (페이징 O, 사용 중 쿼리) -->
	<select id="selectMyDraftList" parameterType="map" resultMap="authorizationDocumentMap">
		WITH APV_DOC AS	(
				SELECT A.* FROM (
			        SELECT ROWNUM RNUM
		             , ATRZ_DOC_ID
		              , ATRZ_USER_ID
		              , ATRZ_DOC_TMPL_ID
		              , ATRZ_DOC_TTL
		              , ATRZ_SBMT_DT
		              , CRNT_ATRZ_STEP_CD
		              , DEL_YN
		              , OPEN_YN
		              , ATRZ_FILE_ID
		              , ATRZ_DOC_TMPL_NM
		              , ATRZ_CATEGORY
		              , drafterName
		              , drafterJbgdNm
					  , drafterDeptNm
		              , drafterFilePath
		              , crntAtrzStepNm
		          FROM (
					  SELECT
					      d.ATRZ_DOC_ID
					      , d.ATRZ_USER_ID
					      , d.ATRZ_DOC_TMPL_ID
					      , d.ATRZ_DOC_TTL
					      , d.ATRZ_SBMT_DT
					      , d.CRNT_ATRZ_STEP_CD
					      , d.DEL_YN
					      , d.OPEN_YN
					      , d.ATRZ_FILE_ID
					      , t.ATRZ_DOC_TMPL_NM
					      , t.ATRZ_CATEGORY
					      , u.USER_NM				 AS drafterName
					      , j.JBGD_NM				 AS drafterJbgdNm		<!-- 기안자 직급명 -->
					      , dp.DEPT_NM				 AS drafterDeptNm		<!-- 기안자 부서명 -->
					      , fd.FILE_PATH         	 AS drafterFilePath		<!-- 기안자 프로필 이미지 -->
					      , cc_doc.CODE_NM           AS crntAtrzStepNm   	<!-- 처리상태 -->
					  FROM AUTHORIZATION_DOCUMENT d
					  LEFT JOIN
						  	AUTHORIZATION_DOCUMENT_TEMPLATE t				<!-- 기안서 템플릿 테이블 조인 -->
						    ON t.ATRZ_DOC_TMPL_ID = d.ATRZ_DOC_TMPL_ID
					  JOIN
						  	USERS u											<!-- 사용자 테이블 테이블 조인 -->
						    ON u.USER_ID = d.ATRZ_USER_ID
					  LEFT JOIN
						  	JOB_GRADE j
						  	ON u.JBGD_CD = j.JBGD_CD
					   LEFT JOIN
						  	DEPARTMENT dp
						  	ON u.DEPT_ID = dp.DEPT_ID
					  LEFT JOIN
	                        FILE_DETAIL fd
	                        ON u.USER_IMG_FILE_ID = fd.FILE_ID
					  LEFT JOIN
						  	COMMON_CODE cc_doc								<!-- 공통코드 테이블 조인 (공통코드 CODE_ID = 기안문 문서상태코드) -->
						    ON cc_doc.CODE_ID = d.CRNT_ATRZ_STEP_CD
					  WHERE
					 	 	NVL(d.DEL_YN,'N') = 'N'								<!-- (WHERE) 삭제되지 않은 기안문만 -->
					  AND
					  		d.ATRZ_USER_ID = #{userId}	<!-- 기안자가 사용자ID -->
					  <include refid="myApprovalSearchFrag" />
				      <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
				          AND d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus}
				      </if>
				       ORDER BY 
				       		d.ATRZ_SBMT_DT DESC
				      	
				<include refid="pagingFooter" />
		)

			SELECT apv.*
				  , al.ATRZ_LINE_SEQ								<!-- 결재 순서 -->
				  , al.ATRZ_APPR_USER_ID						    <!-- 결재자ID -->
				  , al.ATRZ_APPR_STTS								<!-- 결재자상태 -->
				  , al.PRCS_DT										<!-- 처리일시 -->
				  , al.ATRZ_ACT										<!-- 결재행위 -->
				  , u.USER_NM as atrzApprUserNm
				  , j.JBGD_NM
				  , d.DEPT_NM
				  , fd.FILE_PATH
				FROM APV_DOC apv
				LEFT JOIN
				    AUTHORIZATION_LINE al							<!-- 결재선 테이블 조인 -->
				    ON apv.ATRZ_DOC_ID = al.ATRZ_DOC_ID
				LEFT JOIN
				    USERS U
				    ON U.USER_ID = al.ATRZ_APPR_USER_ID
				LEFT JOIN
				    JOB_GRADE J
				    ON U.JBGD_CD = J.JBGD_CD
				LEFT JOIN
				    DEPARTMENT D
				    ON U.DEPT_ID = D.DEPT_ID
				LEFT JOIN
				    FILE_DETAIL FD
				    ON U.USER_IMG_FILE_ID = FD.FILE_ID
				ORDER BY
                    apv.ATRZ_SBMT_DT DESC, al.ATRZ_LINE_SEQ

<!-- SELECT A.* FROM ( -->
<!-- 	SELECT ROWNUM RNUM, B.* FROM ( -->
<!-- 	  	SELECT -->
<!-- 		      d.ATRZ_DOC_ID        AS atrzDocId, -->
<!-- 		      d.ATRZ_USER_ID       AS atrzUserId, -->
<!-- 		      d.ATRZ_DOC_TMPL_ID   AS atrzDocTmplId, -->
<!-- 		      d.ATRZ_DOC_TTL       AS atrzDocTtl, -->
<!-- 		      d.ATRZ_SBMT_DT       AS atrzSbmtDt, -->
<!-- 		      d.CRNT_ATRZ_STEP_CD  AS crntAtrzStepCd, -->
<!-- 		      d.DEL_YN             AS delYn, -->
<!-- 		      d.HTML_DATA          AS htmlData, -->
<!-- 		      d.OPEN_YN            AS openYn, -->
<!-- 		      d.ATRZ_FILE_ID       AS atrzFileId, -->
<!-- 		      t.ATRZ_DOC_TMPL_NM   AS atrzDocTmplNm, -->
<!-- 		      u.USER_NM            AS drafterName, -->
<!-- 		      cc.CODE_NM           AS crntAtrzStepNm -->
<!-- 		  FROM -->
<!-- 		  AUTHORIZATION_DOCUMENT d -->
<!-- 		  JOIN AUTHORIZATION_DOCUMENT_TEMPLATE t -->
<!-- 		    ON t.ATRZ_DOC_TMPL_ID = d.ATRZ_DOC_TMPL_ID -->
<!-- 		  JOIN USERS u -->
<!-- 		    ON u.USER_ID = d.ATRZ_USER_ID -->
<!-- 		  LEFT JOIN COMMON_CODE cc -->
<!-- 		    ON cc.CODE_ID = d.CRNT_ATRZ_STEP_CD -->
<!-- 		  WHERE -->
<!-- 		  d.ATRZ_USER_ID = #{userId} -->
<!-- 		    AND NVL(d.DEL_YN,'N') = 'N' -->
<!-- 		  <include refid="myApprovalSearchFrag" /> -->
<!-- 	      <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)"> -->
<!-- 	          AND d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus} -->
<!-- 	      </if> -->
<!-- 		  ORDER BY -->
<!-- 		   d.ATRZ_SBMT_DT DESC -->
<!-- 		<include refid="pagingFooter" /> -->

	</select>

<!--==========================[나에게 온 결재] (결재대기 + 참조) ====================================-->
	<select id="countMyInboxCombined" parameterType="map" resultType="int">
        SELECT COUNT(*)
		FROM AUTHORIZATION_DOCUMENT d
		JOIN USERS u ON u.USER_ID = d.ATRZ_USER_ID
		LEFT JOIN (
		    SELECT l.ATRZ_DOC_ID, l.ATRZ_APPR_STTS
		      FROM AUTHORIZATION_LINE l
		     WHERE l.ATRZ_APPR_USER_ID = #{userId}
		       AND l.ATRZ_APPR_STTS IN ('A301','A302')
		       AND l.ATRZ_LINE_SEQ = (
		             SELECT MIN(l2.ATRZ_LINE_SEQ)
		               FROM AUTHORIZATION_LINE l2
		              WHERE l2.ATRZ_DOC_ID = l.ATRZ_DOC_ID
		                AND l2.ATRZ_APPR_STTS IN ('A301','A302')
		         )
		) cur ON cur.ATRZ_DOC_ID = d.ATRZ_DOC_ID
		WHERE NVL(d.DEL_YN,'N') = 'N'
		  AND cur.ATRZ_DOC_ID IS NOT NULL
        <include refid="myApprovalSearchFrag" />
        <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
            AND cur.ATRZ_APPR_STTS = #{paging.simpleSearch.searchStatus}
        </if>
    </select>

	<!-- 나에게 온 결재 (페이징 O, 사용 중) -->
	<select id="selectMyInboxCombined" parameterType="map" resultMap="authorizationDocumentMap">
	WITH APV_DOC AS	(
		SELECT A.* FROM (
	        SELECT ROWNUM RNUM
	        , ATRZ_DOC_ID
              , ATRZ_USER_ID
              , ATRZ_DOC_TMPL_ID
              , ATRZ_DOC_TTL
              , ATRZ_SBMT_DT
              , CRNT_ATRZ_STEP_CD
              , DEL_YN
              , OPEN_YN
              , ATRZ_FILE_ID
              , ATRZ_DOC_TMPL_NM
              , ATRZ_CATEGORY
              , drafterName
              , drafterJbgdNm
			  , drafterDeptNm
              , drafterFilePath
              , crntAtrzStepNm
              , myApprStts
		FROM (
			  SELECT
			   d.ATRZ_DOC_ID
			    , d.ATRZ_USER_ID
			    , d.ATRZ_DOC_TMPL_ID
			    , d.ATRZ_DOC_TTL
			    , d.ATRZ_SBMT_DT
			    , d.CRNT_ATRZ_STEP_CD
			    , d.DEL_YN
			    , d.OPEN_YN
			    , d.ATRZ_FILE_ID
				, t.ATRZ_DOC_TMPL_NM
				, t.ATRZ_CATEGORY
			    , u.USER_NM				 AS drafterName
		        , j.JBGD_NM				 AS drafterJbgdNm			<!-- 기안자 직급명 -->
		        , dp.DEPT_NM				 AS drafterDeptNm		<!-- 기안자 부서명 -->
		        , fd.FILE_PATH         	 AS drafterFilePath			<!-- 기안자 프로필 이미지 -->
			    , NVL(cc_line.CODE_NM, cc_doc.CODE_NM) AS crntAtrzStepNm
			   , cur.ATRZ_APPR_STTS       AS myApprStts        		<!-- 결재상태 코드 (JSP 로직에서 사용) -->
			FROM AUTHORIZATION_DOCUMENT d
			JOIN AUTHORIZATION_DOCUMENT_TEMPLATE t
			  ON t.ATRZ_DOC_TMPL_ID = d.ATRZ_DOC_TMPL_ID
			JOIN
			  	USERS u												<!-- 사용자 테이블 테이블 조인 -->
			    ON u.USER_ID = d.ATRZ_USER_ID
		    LEFT JOIN
			  	JOB_GRADE j
			  	ON u.JBGD_CD = j.JBGD_CD
		    LEFT JOIN
			  	DEPARTMENT dp
			  	ON u.DEPT_ID = dp.DEPT_ID
		   	LEFT JOIN
	            FILE_DETAIL fd
	            ON u.USER_IMG_FILE_ID = fd.FILE_ID
			LEFT JOIN COMMON_CODE cc_doc								<!-- 공통코드 조인 (문서상태) -->
				ON cc_doc.CODE_ID = d.CRNT_ATRZ_STEP_CD
			LEFT JOIN (													<!-- 결재선 조인 (결재자 ID 가 사용자 ID 이며,  -->
			    SELECT l.ATRZ_DOC_ID, l.ATRZ_APPR_STTS, l.ATRZ_LINE_SEQ	<!-- 결재상태가 미열람, 미처리이고 -->
			      FROM AUTHORIZATION_LINE l								<!-- 결재선 시퀀스가 제일 작은 것? ) -->
			WHERE l.ATRZ_APPR_USER_ID = #{userId}
			       AND l.ATRZ_APPR_STTS IN ('A301','A302')
			       AND l.ATRZ_LINE_SEQ = (
			             SELECT MIN(l2.ATRZ_LINE_SEQ)
			               FROM AUTHORIZATION_LINE l2
			              WHERE l2.ATRZ_DOC_ID = l.ATRZ_DOC_ID
			                AND l2.ATRZ_APPR_STTS IN ('A301','A302')
			         )
			) cur
			  ON cur.ATRZ_DOC_ID = d.ATRZ_DOC_ID
			LEFT JOIN COMMON_CODE cc_line						<!-- 공통코드 조인 (결재자상태) -->
			  ON cc_line.CODE_ID = cur.ATRZ_APPR_STTS
			WHERE NVL(d.DEL_YN,'N') = 'N'						<!-- 삭제되지 않은 문서 -->
			  AND cur.ATRZ_DOC_ID IS NOT NULL					<!-- 기안서 ID 가 null 이 아닌것 -->
			<include refid="myApprovalSearchFrag" />
	        <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
	            AND cur.ATRZ_APPR_STTS = #{paging.simpleSearch.searchStatus}
	        </if>
			ORDER BY
			  CASE
			    WHEN cur.ATRZ_DOC_ID IS NOT NULL THEN 0 ELSE 1	<!-- 이거 뭐지 -->
			  END,
			  d.ATRZ_SBMT_DT DESC
			<include refid="pagingFooter" />
	)

	 SELECT apv.*
				  , al.ATRZ_LINE_SEQ								<!-- 결재 순서 -->
				  , al.ATRZ_APPR_USER_ID							<!-- 결재자ID -->
				  , al.ATRZ_APPR_STTS								<!-- 결재자상태 -->
				  , al.PRCS_DT										<!-- 처리일시 -->
				  , al.ATRZ_ACT										<!-- 결재행위 -->
				  , u.USER_NM as atrzApprUserNm
				  , j.JBGD_NM
				  , d.DEPT_NM
				  , fd.FILE_PATH
				FROM APV_DOC apv
				LEFT JOIN
				    AUTHORIZATION_LINE al							<!-- 결재선 테이블 조인 -->
				    ON apv.ATRZ_DOC_ID = al.ATRZ_DOC_ID
				LEFT JOIN
				    USERS U
				    ON U.USER_ID = al.ATRZ_APPR_USER_ID
				LEFT JOIN
				    JOB_GRADE J
				    ON U.JBGD_CD = J.JBGD_CD
				LEFT JOIN
				    DEPARTMENT D
				    ON U.DEPT_ID = D.DEPT_ID
				LEFT JOIN
				    FILE_DETAIL FD
				    ON U.USER_IMG_FILE_ID = FD.FILE_ID
				ORDER BY
                    apv.ATRZ_SBMT_DT DESC, al.ATRZ_LINE_SEQ							<!-- 결재라인 순번대로.. 문제시 다시 검토필요 -->
	</select>

<!-- ========================전체 [나의 기안] + [나에게 온 결재]==================================== -->
	<select id="countMyAllCombined" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM AUTHORIZATION_DOCUMENT d
        JOIN USERS u ON u.USER_ID = d.ATRZ_USER_ID
        				LEFT JOIN (
        		            SELECT DISTINCT l.ATRZ_DOC_ID, l.ATRZ_APPR_STTS
        		              FROM AUTHORIZATION_LINE l
        		             WHERE l.ATRZ_APPR_USER_ID = #{userId}
        		               AND l.ATRZ_APPR_STTS IN ('A301','A302','A303')
        		        ) cur ON cur.ATRZ_DOC_ID = d.ATRZ_DOC_ID        WHERE NVL(d.DEL_YN,'N') = 'N'
          AND ( d.ATRZ_USER_ID = #{userId} OR cur.ATRZ_DOC_ID IS NOT NULL )
        <include refid="myApprovalSearchFrag" />
        <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
            AND (
                 d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus}
                 OR cur.ATRZ_APPR_STTS = #{paging.simpleSearch.searchStatus}
            )
        </if>
    </select>

	<select id="selectMyAllCombined" parameterType="map" resultMap="authorizationDocumentMap">
		WITH APV_DOC AS	(
				SELECT A.* FROM (
			        SELECT ROWNUM RNUM
		              , ATRZ_DOC_ID
		              , ATRZ_USER_ID
		              , ATRZ_DOC_TMPL_ID
		              , ATRZ_DOC_TTL
		              , ATRZ_SBMT_DT
		              , CRNT_ATRZ_STEP_CD
		              , DEL_YN
<!-- 		              , HTML_DATA -->
		              , OPEN_YN
		              , ATRZ_FILE_ID
		              , ATRZ_DOC_TMPL_NM
		              , ATRZ_CATEGORY
		              , drafterName
		              , drafterJbgdNm
					  , drafterDeptNm
		              , drafterFilePath
		              , crntAtrzStepNm
		              , myApprSttsNm
		              , myApprStts
		          FROM (
					  SELECT
					      d.ATRZ_DOC_ID
					      , d.ATRZ_USER_ID
					      , d.ATRZ_DOC_TMPL_ID
					      , d.ATRZ_DOC_TTL
					      , d.ATRZ_SBMT_DT
					      , d.CRNT_ATRZ_STEP_CD
					      , d.DEL_YN
<!-- 					      , d.HTML_DATA -->
					      , d.OPEN_YN
					      , d.ATRZ_FILE_ID
					      , t.ATRZ_DOC_TMPL_NM
					      , t.ATRZ_CATEGORY
					      , u.USER_NM				 AS drafterName
					      , j.JBGD_NM				 AS drafterJbgdNm		<!-- 기안자 직급명 -->
					      , dp.DEPT_NM				 AS drafterDeptNm		<!-- 기안자 부서명 -->
					      , fd.FILE_PATH         	 AS drafterFilePath		<!-- 기안자 프로필 이미지 -->
					      , cc_doc.CODE_NM           AS crntAtrzStepNm   	<!-- 처리상태 -->
					      , cc_line.CODE_NM          AS myApprSttsNm     	<!-- 결재상태 -->
					      , cur.ATRZ_APPR_STTS       AS myApprStts        	<!-- 결재상태 코드 (JSP 로직에서 사용) -->

					  FROM AUTHORIZATION_DOCUMENT d
					  LEFT JOIN
						  	AUTHORIZATION_DOCUMENT_TEMPLATE t					<!-- 기안서 템플릿 테이블 조인 -->
						    ON t.ATRZ_DOC_TMPL_ID = d.ATRZ_DOC_TMPL_ID
					  JOIN
						  	USERS u												<!-- 사용자 테이블 테이블 조인 -->
						    ON u.USER_ID = d.ATRZ_USER_ID
					  LEFT JOIN
						  	JOB_GRADE j
						  	ON u.JBGD_CD = j.JBGD_CD
					   LEFT JOIN
						  	DEPARTMENT dp
						  	ON u.DEPT_ID = dp.DEPT_ID
					  LEFT JOIN
	                        FILE_DETAIL fd
	                        ON u.USER_IMG_FILE_ID = fd.FILE_ID
					  LEFT JOIN
						  	COMMON_CODE cc_doc									<!-- 공통코드 테이블 조인 (공통코드 CODE_ID = 기안문 문서상태코드) -->
						    ON cc_doc.CODE_ID = d.CRNT_ATRZ_STEP_CD
					  LEFT JOIN (
					      SELECT DISTINCT l.ATRZ_DOC_ID, l.ATRZ_APPR_STTS	<!-- 결재선 테이블에서 나의 상태? 조인 -->
					        FROM AUTHORIZATION_LINE l
					       WHERE l.ATRZ_APPR_USER_ID = #{userId}
					         AND l.ATRZ_APPR_STTS IN ('A301','A302','A303')
					  ) cur
					    ON cur.ATRZ_DOC_ID = d.ATRZ_DOC_ID
					  LEFT JOIN
						  	COMMON_CODE cc_line									<!-- 공통코드 테이블 조인 (공통코드 CODE_ID = 결재선테이블 나의 상태코드) -->
						    ON cc_line.CODE_ID = cur.ATRZ_APPR_STTS
					  WHERE
					 	 	NVL(d.DEL_YN,'N') = 'N'								<!-- (WHERE) 삭제되지 않은 기안문만 -->
					  AND
					    ( d.ATRZ_USER_ID = #{userId} OR cur.ATRZ_DOC_ID IS NOT NULL )	<!-- 사용자ID 가 존재하거나 기안문 아이디가 NULL 이 아니면 -->
					  <include refid="myApprovalSearchFrag" />
				      <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
				          AND d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus}
				      </if>
				       ORDER BY 
				       		d.ATRZ_SBMT_DT DESC
				<include refid="pagingFooter" />
		)

				SELECT apv.*
				  , al.ATRZ_LINE_SEQ								<!-- 결재 순서 -->
				  , al.ATRZ_APPR_USER_ID							<!-- 결재자ID -->
				  , al.ATRZ_APPR_STTS								<!-- 결재자상태 -->
				  , al.PRCS_DT										<!-- 처리일시 -->
				  , al.ATRZ_ACT										<!-- 결재행위 -->
				  , u.USER_NM as atrzApprUserNm
				  , j.JBGD_NM
				  , d.DEPT_NM
				  , fd.FILE_PATH
				FROM APV_DOC apv
				LEFT JOIN
				    AUTHORIZATION_LINE al							<!-- 결재선 테이블 조인 -->
				    ON apv.ATRZ_DOC_ID = al.ATRZ_DOC_ID
				LEFT JOIN
				    USERS U
				    ON U.USER_ID = al.ATRZ_APPR_USER_ID
				LEFT JOIN
				    JOB_GRADE J
				    ON U.JBGD_CD = J.JBGD_CD
				LEFT JOIN
				    DEPARTMENT D
				    ON U.DEPT_ID = D.DEPT_ID
				LEFT JOIN
				    FILE_DETAIL FD
				    ON U.USER_IMG_FILE_ID = FD.FILE_ID
				ORDER BY
                    apv.ATRZ_SBMT_DT DESC, al.ATRZ_LINE_SEQ							<!-- 결재라인 순번대로.. 문제시 다시 검토필요 -->
	</select>

<!-- ========================내가 결재한 문서==================================== -->
	<select id="countMyProcessedList" parameterType="map" resultType="int">
        SELECT COUNT(*)
		FROM AUTHORIZATION_DOCUMENT d
		JOIN USERS u ON u.USER_ID = d.ATRZ_USER_ID
		JOIN (
		    SELECT l.ATRZ_DOC_ID
		    FROM AUTHORIZATION_LINE l
		    WHERE l.ATRZ_APPR_USER_ID = #{userId}
		      AND l.ATRZ_APPR_STTS = 'A303' -- 처리완료
		) processed ON processed.ATRZ_DOC_ID = d.ATRZ_DOC_ID
		WHERE NVL(d.DEL_YN,'N') = 'N'
		  AND d.ATRZ_USER_ID != #{userId}
        <include refid="myApprovalSearchFrag" />
        <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
            AND d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus}
        </if>
    </select>

    <!-- 내가 결재한 문서 (페이징 O, 사용 중) -->
	<select id="selectMyProcessedList" parameterType="map" resultMap="authorizationDocumentMap">
	WITH APV_DOC AS	(
		SELECT A.* FROM (
	        SELECT ROWNUM RNUM
	        , ATRZ_DOC_ID
              , ATRZ_USER_ID
              , ATRZ_DOC_TMPL_ID
              , ATRZ_DOC_TTL
              , ATRZ_SBMT_DT
              , CRNT_ATRZ_STEP_CD
              , DEL_YN
              , OPEN_YN
              , ATRZ_FILE_ID
              , ATRZ_DOC_TMPL_NM
              , ATRZ_CATEGORY
              , drafterName
              , drafterJbgdNm
			  , drafterDeptNm
              , drafterFilePath
              , crntAtrzStepNm
              , myActCd
		FROM (
			SELECT
				d.ATRZ_DOC_ID
				, d.ATRZ_USER_ID
				, d.ATRZ_DOC_TMPL_ID
				, d.ATRZ_DOC_TTL
				, d.ATRZ_SBMT_DT
				, d.CRNT_ATRZ_STEP_CD
				, d.DEL_YN
				, d.OPEN_YN
				, d.ATRZ_FILE_ID
				, t.ATRZ_DOC_TMPL_NM
				, t.ATRZ_CATEGORY
				, u.USER_NM				 AS drafterName
				, j.JBGD_NM				 AS drafterJbgdNm		<!-- 기안자 직급명 -->
				, dp.DEPT_NM			 AS drafterDeptNm		<!-- 기안자 부서명 -->
				, fd.FILE_PATH         	 AS drafterFilePath		<!-- 기안자 프로필 이미지 -->
				, cc.CODE_NM           		AS crntAtrzStepNm
				, processed.ATRZ_ACT   AS myActCd -- My action on this document
			FROM
				AUTHORIZATION_DOCUMENT d
			JOIN
			  	AUTHORIZATION_DOCUMENT_TEMPLATE t
			  	ON t.ATRZ_DOC_TMPL_ID = d.ATRZ_DOC_TMPL_ID
			JOIN
			  	USERS u												-- 사용자 테이블 테이블 조인 -->
			    ON u.USER_ID = d.ATRZ_USER_ID
			LEFT JOIN
				JOB_GRADE j
			  	ON u.JBGD_CD = j.JBGD_CD
			LEFT JOIN
			  	DEPARTMENT dp
			  	ON u.DEPT_ID = dp.DEPT_ID
			LEFT JOIN
	            FILE_DETAIL fd
	            ON u.USER_IMG_FILE_ID = fd.FILE_ID
			LEFT JOIN
			  	COMMON_CODE cc
			  	ON cc.CODE_ID = d.CRNT_ATRZ_STEP_CD
			JOIN (
			      SELECT l.ATRZ_DOC_ID, l.ATRZ_ACT
			      FROM AUTHORIZATION_LINE l
			      WHERE l.ATRZ_APPR_USER_ID = #{userId}				<!-- 결재자에 사용자ID 가 있고 -->
			        AND l.ATRZ_APPR_STTS = 'A303' -- 처리완료			<!-- 결재자 처리상태가 처리 완료일 때 -->
			  ) processed ON processed.ATRZ_DOC_ID = d.ATRZ_DOC_ID
			  WHERE NVL(d.DEL_YN,'N') = 'N'
			    AND d.ATRZ_USER_ID != #{userId} -- Exclude documents drafted by the user
			  <include refid="myApprovalSearchFrag" />
		      <if test="paging != null and paging.simpleSearch != null and @org.apache.commons.lang3.StringUtils@isNotBlank(paging.simpleSearch.searchStatus)">
		          AND d.CRNT_ATRZ_STEP_CD = #{paging.simpleSearch.searchStatus}
		      </if>
		       ORDER BY 
		       		d.ATRZ_SBMT_DT DESC
			<include refid="pagingFooter" />
		)

		SELECT apv.*
		  , al.ATRZ_LINE_SEQ							<!-- 결재 순서 -->
		  , al.ATRZ_APPR_USER_ID						<!-- 결재자ID -->
		  , al.ATRZ_APPR_STTS							<!-- 결재자상태 -->
		  , al.PRCS_DT									<!-- 처리일시 -->
		  , al.ATRZ_ACT									<!-- 결재행위 -->
		  , u.USER_NM as atrzApprUserNm
		  , j.JBGD_NM
		  , d.DEPT_NM
		  , fd.FILE_PATH
		FROM APV_DOC apv
		LEFT JOIN
		    AUTHORIZATION_LINE al						<!-- 결재선 테이블 조인 -->
		    ON apv.ATRZ_DOC_ID = al.ATRZ_DOC_ID
		LEFT JOIN
		    USERS U
		    ON U.USER_ID = al.ATRZ_APPR_USER_ID
		LEFT JOIN
		    JOB_GRADE J
		    ON U.JBGD_CD = J.JBGD_CD
		LEFT JOIN
		    DEPARTMENT D
		    ON U.DEPT_ID = D.DEPT_ID
		LEFT JOIN
		    FILE_DETAIL FD
		    ON U.USER_IMG_FILE_ID = FD.FILE_ID
		ORDER BY
            apv.ATRZ_SBMT_DT DESC, al.ATRZ_LINE_SEQ
	</select>


	<!-- ===================문서 상태를 변경하기 위한 쿼리====================== -->


	<!-- 문서 상태코드 업데이트 (예: 전결 완료 후 A206: 최종승인) -->
    <update id="updateDocumentStatus">
        UPDATE AUTHORIZATION_DOCUMENT
           SET CRNT_ATRZ_STEP_CD = #{sttsCode}
         WHERE ATRZ_DOC_ID       = #{docId}
    </update>

	<!-- 기안서 정보 업데이트 (지금은 htmlData만.. 가영 추가) -->
	<update id="updateAuthorizationDocument">
		UPDATE
			AUTHORIZATION_DOCUMENT
		SET
<!-- 			ATRZ_DOC_TMPL_ID 		= #{atrzDocTmplId} -->
<!-- 			,ATRZ_DOC_TTL 			= #{atrzDocTtl} -->
<!-- 			,ATRZ_SBMT_DT 			= #{atrzSbmtDt} -->
<!-- 			,CRNT_ATRZ_STEP_CD 		= #{crntAtrzStepCd} -->
<!-- 			,DEL_YN 				= #{delYn} -->
			HTML_DATA 				= #{htmlData}
<!-- 			,OPEN_YN 				= #{openYn} -->
<!-- 			,ATRZ_USER_ID 			= #{atrzUserId} -->
<!-- 			,ATRZ_FILE_ID 			= #{atrzFileId} -->
		WHERE
			ATRZ_DOC_ID 			= #{atrzDocId}
	</update>

	<!-- 문서 상태 및 삭제 여부 업데이트 -->
	<update id="updateDocumentStatusAndDelYn">
		UPDATE AUTHORIZATION_DOCUMENT
		SET
			CRNT_ATRZ_STEP_CD = #{sttsCode},
			DEL_YN = #{delYn}
		WHERE ATRZ_DOC_ID = #{docId}
	</update>


	<select id="selectApprovalCount" resultType="int">
		SELECT COUNT(*)
		FROM AUTHORIZATION_DOCUMENT
		WHERE TRUNC(ATRZ_SBMT_DT) = TRUNC(SYSDATE) <!-- 오늘에 해당하는 날짜만 -->
	</select>



    <select id="selectMonthlyApprovalUsageByCategory" resultType="map">
        SELECT
            TO_CHAR(AD.ATRZ_SBMT_DT, 'YYYY-MM') AS "month",
            ADT.ATRZ_DOC_TMPL_ID AS "templateId",
            ADT.ATRZ_DOC_TMPL_NM AS "templateName",
            COUNT(AD.ATRZ_DOC_ID) AS "count"
        FROM
            AUTHORIZATION_DOCUMENT AD
        JOIN
            AUTHORIZATION_DOCUMENT_TEMPLATE ADT ON AD.ATRZ_DOC_TMPL_ID = ADT.ATRZ_DOC_TMPL_ID
        WHERE AD.ATRZ_SBMT_DT IS NOT NULL
        GROUP BY
            TO_CHAR(AD.ATRZ_SBMT_DT, 'YYYY-MM'),
            ADT.ATRZ_DOC_TMPL_ID,
            ADT.ATRZ_DOC_TMPL_NM
        ORDER BY
            "month", "templateId"
    </select>

</mapper>