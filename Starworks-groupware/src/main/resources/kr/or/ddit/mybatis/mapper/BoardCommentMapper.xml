<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자            수정내용
 *  ============   	============== =======================
 *  2025. 9. 25.     	임가영            최초 생성
 *	2025. 9. 29.		임가영			selectBoardCommentTotalCount(댓글 수) 쿼리 추가
 *	2025. 9. 29.		임가영			selectBoardCommentDetail(댓글 상세조회) 쿼리 추가
 *
-->
<mapper namespace="kr.or.ddit.mybatis.mapper.BoardCommentMapper">

	<resultMap type="kr.or.ddit.vo.BoardCommentVO" id="boardCommentMap" autoMapping="true">
		<association property="users" javaType="kr.or.ddit.vo.UsersVO" autoMapping="true">
		</association>
	</resultMap>

	<select id="selectBoardCommentTotalCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			BOARD_COMMENT
		WHERE
			PST_ID = #{pstId}
		AND
			DEL_YN = 'N'
	</select>

	<!-- 댓글 상세조회 -->
	<select id="selectBoardCommentList" resultMap="boardCommentMap">
		SELECT
			BC.PST_ID
			, BC.CMNT_SQN
			, BC.CRT_USER_ID
			, BC.FRST_CRT_DT
			, BC.LAST_CHG_DT
			, BC.LAST_CHG_USER_ID
			, BC.CONTENTS
			, BC.UP_CMNT_SQN
			, BC.DEL_YN
			, U.USER_NM
			, F.FILE_PATH
		FROM
			BOARD_COMMENT BC
		INNER JOIN USERS U
			ON BC.CRT_USER_ID = U.USER_ID
		LEFT JOIN FILE_DETAIL F
        	ON U.USER_IMG_FILE_ID = F.FILE_ID
		WHERE
			PST_ID = #{pstId}
		ORDER BY
			FRST_CRT_DT
	</select>

	<!-- 대댓글 상세조회 -->
	<select id="selectBoardReplyDetail" resultType="kr.or.ddit.vo.BoardCommentVO" resultMap="boardCommentMap">
		SELECT
			BC.PST_ID
			, BC.CMNT_SQN
			, BC.CRT_USER_ID
			, BC.FRST_CRT_DT
			, BC.LAST_CHG_DT
			, BC.LAST_CHG_USER_ID
			, BC.CONTENTS
			, BC.UP_CMNT_SQN
			, BC.DEL_YN
			, U.USER_NM
			, F.FILE_PATH
		FROM
			BOARD_COMMENT BC
		INNER JOIN USERS U ON BC.CRT_USER_ID = U.USER_ID
		LEFT JOIN FILE_DETAIL F ON U.USER_IMG_FILE_ID = F.FILE_ID
		WHERE
			CMNT_SQN = (
						SELECT
							MAX(CMNT_SQN)
                        FROM
                            (
                            SELECT
                                PST_ID
                                , CMNT_SQN
                                , UP_CMNT_SQN
                            FROM
                            	BOARD_COMMENT
                            )
                        WHERE
                        	PST_ID = #{pstId}
                        AND
                        	UP_CMNT_SQN = #{upCmntSqn}
                        )

	</select>

	<!-- 댓글 상세조회 -->
	<select id="selectBoardCommentDetail" resultType="kr.or.ddit.vo.BoardCommentVO">
		SELECT
			BC.PST_ID
			, BC.CMNT_SQN
			, BC.CRT_USER_ID
			, BC.FRST_CRT_DT
			, BC.LAST_CHG_DT
			, BC.LAST_CHG_USER_ID
			, BC.CONTENTS
			, BC.UP_CMNT_SQN
			, BC.DEL_YN
			, U.USER_NM
		FROM
			BOARD_COMMENT BC
		INNER JOIN USERS U ON BC.CRT_USER_ID = U.USER_ID
		WHERE
			CMNT_SQN = #{cmntSqn}
	</select>

	<insert id="insertBoardComment">
		<selectKey keyProperty="cmntSqn" order="BEFORE" resultType="int">
			select CMNT_SQN_SEQ.nextval from dual
		</selectKey>
		INSERT INTO BOARD_COMMENT (
			CMNT_SQN
			, PST_ID
			, UP_CMNT_SQN
			, CRT_USER_ID
			, CONTENTS
		) VALUES (
			#{cmntSqn}
			, #{pstId}
			, #{upCmntSqn}
			, #{crtUserId}
			, #{contents}
		)
	</insert>

	<update id="updateBoardComment">
		UPDATE
			BOARD_COMMENT
		SET
			CONTENTS = #{contents}
			, LAST_CHG_DT = SYSDATE
			, LAST_CHG_USER_ID = #{crtUserId}
		WHERE
		    CMNT_SQN = #{cmntSqn}
	</update>

	<update id="deleteBoardComment">
		UPDATE
			BOARD_COMMENT
		SET
			DEL_YN = 'Y'
	    WHERE
	    	CMNT_SQN = #{cmntSqn}
	</update>

</mapper>