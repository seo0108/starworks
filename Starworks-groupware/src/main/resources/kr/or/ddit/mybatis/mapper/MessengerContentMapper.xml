<?xml version="1.0" encoding="UTF-8"?>
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 9. 26.     	윤서현            최초 생성
 * 	2025. 10. 14. 		김주민			updateReadStatus, selectMessengerContentByRoomId 추가
 *
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mybatis.mapper.MessengerContentMapper">

<!-- 특정 채팅방의 메시지 목록 조회(사용자 이름 포함) -->
<select id="selectMessengerContentByRoomId" resultType="kr.or.ddit.vo.MessengerContentVO">
	SELECT
    mc.MSG_CONT_ID,
    mc.MSGR_ID,
    mc.USER_ID,
    u.USER_NM,
    j.JBGD_NM,
    d.DEPT_NM,
    mc.CONTENTS,
    mc.SEND_DT,
    mc.READ_YN,
    mc.DEL_YN,
    mc.MSG_FILE_ID,
    fd.FILE_PATH AS USER_FILE_PATH,
    (
        SELECT COUNT(*)
        FROM MESSENGER_USER mu
        WHERE mu.MSGR_ID = mc.MSGR_ID
        AND (mu.LEFT_DT IS NULL OR mu.LEFT_DT = '')
        AND mu.USER_ID != mc.USER_ID
        AND mu.USER_ID NOT IN (
            SELECT mr.USER_ID
            FROM MESSENGER_READ mr
            WHERE mr.MSG_CONT_ID = mc.MSG_CONT_ID
        )
    ) AS UNREAD_COUNT
FROM
    MESSENGER_CONTENT mc
LEFT JOIN
    USERS u ON mc.USER_ID = u.USER_ID
LEFT JOIN
    FILE_DETAIL fd ON u.USER_IMG_FILE_ID = fd.FILE_ID
LEFT JOIN
    JOB_GRADE j ON u.JBGD_CD = j.JBGD_CD
LEFT JOIN
    DEPARTMENT d ON u.DEPT_ID = d.DEPT_ID
WHERE
    mc.MSGR_ID = #{msgrId}
    AND mc.DEL_YN = 'N'
ORDER BY
    mc.SEND_DT ASC
</select>

<!-- 메시지 읽음 처리 -->
<update id="updateReadStatus">
	UPDATE MESSENGER_CONTENT
	SET READ_YN = 'Y'
	WHERE MSG_CONT_ID = #{msgContId}
</update>

	<insert id="insertMessengerContent">
		INSERT INTO MESSENGER_CONTENT(
			MSG_CONT_ID
			,USER_ID
			,MSGR_ID
			,CONTENTS
			,SEND_DT
			,DEL_YN
			,READ_YN
			,MSG_FILE_ID
		)VALUES(
		 	#{msgContId}
			 ,#{userId}
			 ,#{msgrId}
			 ,#{contents}
			 ,#{sendDt}
			 ,#{delYn}
			 ,#{readYn}
			 ,#{msgFileId}
		)
	</insert>

	<select id="selectMessengerContentList" resultType="kr.or.ddit.vo.MessengerContentVO">
		SELECT
			MSG_CONT_ID
			,USER_ID
			,MSGR_ID
			,CONTENTS
			,SEND_DT
			,DEL_YN
			,READ_YN
			,MSG_FILE_ID
		FROM
			MESSENGER_CONTENT
	</select>

	<delete id="deleteMessengerContent">
		DELETE FROM MESSENGER_CONTENT
		WHERE MSG_CONT_ID = #{msgContId}
	</delete>
</mapper>