<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자            수정내용
 *  ============   	============== =======================
 *  2025. 10. 15.     	임가영            최초 생성
 *
-->
<mapper namespace="kr.or.ddit.mybatis.mapper.UserHistoryMapper">

	<!-- 인사기록 전체 조회 -->
	<select id="selectUserHistoryList" resultType="kr.or.ddit.vo.UserHistoryVO">
		SELECT
			H.HISTORY_ID
			, H.USER_ID
			, H.CHANGE_TYPE
			, H.BEFORE_DEPT_ID
			, H.AFTER_DEPT_ID
			, H.BEFORE_JBGD_CD
			, H.AFTER_JBGD_CD
			, H.REASON
			, H.CRT_DT
			, U.USER_NM
			, BD.DEPT_NM AS BEFORE_DEPT_NM
    		, AD.DEPT_NM AS AFTER_DEPT_NM
    		, BJ.JBGD_NM AS BEFORE_JBGD_NM
    		, AJ.JBGD_NM AS AFTER_JBGD_NM
		FROM
			USER_HISTORY H
		LEFT OUTER JOIN USERS U
			ON H.USER_ID = U.USER_ID
		LEFT OUTER JOIN DEPARTMENT BD
			ON H.BEFORE_DEPT_ID = BD.DEPT_ID
		LEFT OUTER JOIN DEPARTMENT AD
			ON H.AFTER_DEPT_ID = AD.DEPT_ID
		LEFT OUTER JOIN JOB_GRADE BJ
			ON H.BEFORE_JBGD_CD = BJ.JBGD_CD
		LEFT OUTER JOIN JOB_GRADE AJ
			ON H.AFTER_JBGD_CD = AJ.JBGD_CD
		ORDER BY
			CRT_DT DESC
	</select>

	<!-- 부서별 인사기록 조회 -->
	<select id="selectUserHistoryByDept" resultType="kr.or.ddit.vo.UserHistoryVO">
		SELECT
			H.HISTORY_ID
			, H.USER_ID
			, H.CHANGE_TYPE
			, H.BEFORE_DEPT_ID
			, H.AFTER_DEPT_ID
			, H.BEFORE_JBGD_CD
			, H.AFTER_JBGD_CD
			, H.REASON
			, H.CRT_DT
			, U.USER_NM
			, BD.DEPT_NM AS BEFORE_DEPT_NM
    		, AD.DEPT_NM AS AFTER_DEPT_NM
    		, BJ.JBGD_NM AS BEFORE_JBGD_NM
    		, AJ.JBGD_NM AS AFTER_JBGD_NM
		FROM
			USER_HISTORY H
		LEFT OUTER JOIN USERS U
			ON H.USER_ID = U.USER_ID
		LEFT OUTER JOIN DEPARTMENT BD
			ON H.BEFORE_DEPT_ID = BD.DEPT_ID
		LEFT OUTER JOIN DEPARTMENT AD
			ON H.AFTER_DEPT_ID = AD.DEPT_ID
		LEFT OUTER JOIN JOB_GRADE BJ
			ON H.BEFORE_JBGD_CD = BJ.JBGD_CD
		LEFT OUTER JOIN JOB_GRADE AJ
			ON H.AFTER_JBGD_CD = AJ.JBGD_CD
		WHERE
			U.DEPT_ID = #{deptId}
		ORDER BY
			H.CRT_DT DESC
	</select>

	<!-- 개인별 인사기록 조회 -->
	<select id="selectUserHistoryByUser" resultType="kr.or.ddit.vo.UserHistoryVO">
		SELECT
			H.HISTORY_ID
			, H.USER_ID
			, H.CHANGE_TYPE
			, H.BEFORE_DEPT_ID
			, H.AFTER_DEPT_ID
			, H.BEFORE_JBGD_CD
			, H.AFTER_JBGD_CD
			, H.REASON
			, H.CRT_DT
			, U.USER_NM
			, BD.DEPT_NM AS BEFORE_DEPT_NM
    		, AD.DEPT_NM AS AFTER_DEPT_NM
    		, BJ.JBGD_NM AS BEFORE_JBGD_NM
    		, AJ.JBGD_NM AS AFTER_JBGD_NM
		FROM
			USER_HISTORY H
		LEFT OUTER JOIN USERS U
			ON H.USER_ID = U.USER_ID
		LEFT OUTER JOIN DEPARTMENT BD
			ON H.BEFORE_DEPT_ID = BD.DEPT_ID
		LEFT OUTER JOIN DEPARTMENT AD
			ON H.AFTER_DEPT_ID = AD.DEPT_ID
		LEFT OUTER JOIN JOB_GRADE BJ
			ON H.BEFORE_JBGD_CD = BJ.JBGD_CD
		LEFT OUTER JOIN JOB_GRADE AJ
			ON H.AFTER_JBGD_CD = AJ.JBGD_CD
		WHERE
			H.USER_ID = #{userId}
		ORDER BY
			H.CRT_DT DESC
	</select>

	<!-- 인사기록 한 건 조회 -->
	<select id="selectUserHistory" resultType="kr.or.ddit.vo.UserHistoryVO">
		SELECT
			H.HISTORY_ID
			, H.USER_ID
			, H.CHANGE_TYPE
			, H.BEFORE_DEPT_ID
			, H.AFTER_DEPT_ID
			, H.BEFORE_JBGD_CD
			, H.AFTER_JBGD_CD
			, H.REASON
			, H.CRT_DT
			, U.USER_NM
			, BD.DEPT_NM AS BEFORE_DEPT_NM
    		, AD.DEPT_NM AS AFTER_DEPT_NM
    		, BJ.JBGD_NM AS BEFORE_JBGD_NM
    		, AJ.JBGD_NM AS AFTER_JBGD_NM
		FROM
			USER_HISTORY H
		LEFT OUTER JOIN USERS U
			ON H.USER_ID = U.USER_ID
		LEFT OUTER JOIN DEPARTMENT BD
			ON H.BEFORE_DEPT_ID = BD.DEPT_ID
		LEFT OUTER JOIN DEPARTMENT AD
			ON H.AFTER_DEPT_ID = AD.DEPT_ID
		LEFT OUTER JOIN JOB_GRADE BJ
			ON H.BEFORE_JBGD_CD = BJ.JBGD_CD
		LEFT OUTER JOIN JOB_GRADE AJ
			ON H.AFTER_JBGD_CD = AJ.JBGD_CD
		WHERE
			H.HISTORY_ID = #{historyId}
	</select>

	<!-- 인사기록 데이터 삽입 -->
	<insert id="insertUserHistory">
		<selectKey keyProperty="historyId" order="BEFORE" resultType="int">
			SELECT USER_HISTORY_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			USER_HISTORY(
				HISTORY_ID
				, USER_ID
				, CHANGE_TYPE
				, BEFORE_DEPT_ID
				, AFTER_DEPT_ID
				, BEFORE_JBGD_CD
				, AFTER_JBGD_CD
				, REASON
				<if test="crtDt != null">
				, CRT_DT
				</if>
			) VALUES (
				#{historyId}
				, #{userId}
				, #{changeType}
				, #{beforeDeptId}
				, #{afterDeptId}
				, #{beforeJbgdCd}
				, #{afterJbgdCd}
				, #{reason}
				<if test="crtDt != null">
				, #{crtDt}
				</if>
			)
	</insert>

</mapper>