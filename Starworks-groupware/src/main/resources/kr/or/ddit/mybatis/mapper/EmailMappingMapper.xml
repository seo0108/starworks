<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * == 개정이력(Modification Information) ==
 *
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 9. 25.     	홍현택            쿼리 작성
 *	2025.10. 10.		홍현택			이메일 읽음 표시 업데이트 위한 쿼리 추가 updateReadStatus
 *	2025.10. 10.		홍현택			임시저장 수정 시 deleteEmailMappingsByEmailId로 매핑정보 삭제
 *	2025.10. 10. 		홍현택			메일 삭제 관련 쿼리 메서드 추가
 *  2025.10. 16.		홍현택			휴지통 복원용 매핑 정보 수정 updateEmailMapping
 *
-->

<mapper namespace="kr.or.ddit.mybatis.mapper.EmailMappingMapper">


<!--insertEmailMapping
      - 메일 콘텐츠(EMAIL_CONT_ID)와 메일함(MAILBOX_ID) 사이의 매핑 행을 신규 생성.
      - 한 이메일이 여러 메일함(수신함/보낸함/중요 등)에 매핑될 수 있음(사용자별 사본 개념). -->
  <insert id="insertEmailMapping" parameterType="kr.or.ddit.vo.EmailMappingVO">
    INSERT INTO EMAIL_MAPPING (
        MAILBOX_ID,
        EMAIL_CONT_ID,
        READ_YN,
        READ_DT,
        DEL_YN,
        DEL_DT
    ) VALUES (
        #{mailboxId},
        #{emailContId},
        NVL(#{readYn}, 'N'),
        #{readDt},
        NVL(#{delYn}, 'N'),
        #{delDt}
    )
  </insert>
<!--
    selectEmailMappingList
      - EMAIL_MAPPING 전체 목록을 조회.-->
  <select id="selectEmailMappingList" resultType="kr.or.ddit.vo.EmailMappingVO">
    SELECT
        MAILBOX_ID,
        EMAIL_CONT_ID,
        READ_YN,
        READ_DT,
        DEL_YN,
        DEL_DT
    FROM EMAIL_MAPPING
  </select>

<!--
    selectEmailMapping
      - 특정 메일함과 특정 메일 콘텐츠의 매핑 1건을 조회(복합키 접근).-->
  <select id="selectEmailMapping" resultType="kr.or.ddit.vo.EmailMappingVO" parameterType="map">
    SELECT
        MAILBOX_ID,
        EMAIL_CONT_ID,
        READ_YN,
        READ_DT,
        DEL_YN,
        DEL_DT
      FROM EMAIL_MAPPING
     WHERE MAILBOX_ID = #{mailboxId}
       AND EMAIL_CONT_ID = #{emailContId}
  </select>

<!--
    updateEmailMapping  휴지통에서 메일 복원용.
      - 특정 메일함-이메일 매핑 1건을 수정.
      - 임시저장 메일 수정 시 매핑정보도 수정.-->
  <update id="updateEmailMapping" parameterType="kr.or.ddit.vo.EmailMappingVO">
    UPDATE EMAIL_MAPPING
    SET
        READ_YN = #{readYn},
        READ_DT = #{readDt},
        DEL_YN = #{delYn},
        DEL_DT = #{delDt}
    WHERE
        EMAIL_CONT_ID = #{emailContId} AND MAILBOX_ID = #{mailboxId}
  </update>

<!--
    updateReadStatus
      - 사용자가 특정 이메일(EMAIL_CONT_ID)을 열람했을 때,
        해당 사용자의 모든 관련 메일함 매핑에 대해 읽음 처리(READ_YN='Y', READ_DT=SYSDATE).-->
  <update id="updateReadStatus" parameterType="map">
    UPDATE EMAIL_MAPPING
    SET
        READ_YN = 'Y',
        READ_DT = SYSDATE
    WHERE
        EMAIL_CONT_ID = #{emailContId}
    AND
        MAILBOX_ID IN (SELECT MAILBOX_ID FROM EMAIL_BOX WHERE USER_ID = #{userId})
  </update>

<!--
    deleteEmailMappingsByEmailId
      - 특정 이메일 콘텐츠(EMAIL_CONT_ID)에 대한 모든 매핑 행을 삭제(전 사용자/전 메일함 대상).
      - 임시저장 재작성 등 "기존 매핑 전체 초기화" 시 사용.-->
  <delete id="deleteEmailMappingsByEmailId" parameterType="string">
    DELETE FROM EMAIL_MAPPING
    WHERE EMAIL_CONT_ID = #{emailContId}
  </delete>

<!--
    deleteEmailMapping
      - 특정 메일함-이메일 매핑 1건만 정확히 삭제(사용자별/사본별 물리 삭제).-->
  <delete id="deleteEmailMapping" parameterType="kr.or.ddit.vo.EmailMappingVO">
    DELETE FROM EMAIL_MAPPING
    WHERE EMAIL_CONT_ID = #{emailContId} AND MAILBOX_ID = #{mailboxId}
  </delete>
<!--
    updateMailboxIdForEmail
      - 특정 이메일을 "사용자의 지정 메일함 유형(MAILBOX_TYPE_CD)"으로 이동. 삭제시 휴지통으로 옮길때 사용.-->
  <update id="updateMailboxIdForEmail" parameterType="map">
    UPDATE EMAIL_MAPPING
    SET
        MAILBOX_ID = (SELECT MAILBOX_ID FROM EMAIL_BOX WHERE USER_ID = #{userId} AND MAILBOX_TYPE_CD = #{newMailboxTypeCd}),
        READ_YN = 'N', -- 휴지통으로 이동 시 읽지 않은 상태로
        READ_DT = NULL,
        DEL_YN = 'N',  -- 휴지통에 있으므로 DEL_YN은 'N'
        DEL_DT = NULL
    WHERE
        EMAIL_CONT_ID = #{emailContId}
    AND
        MAILBOX_ID IN (SELECT MAILBOX_ID FROM EMAIL_BOX WHERE USER_ID = #{userId})
  </update>

<!--
    updateEmailMappingDelYn
      - soft delete 처리: 사용자의 해당 이메일 매핑에 대해 DEL_YN='Y', DEL_DT=SYSDATE.
      - 삭제 버튼 시 휴지통과 별개로 삭제 플래그를 남김. -->
  <update id="updateEmailMappingDelYn" parameterType="map">
    UPDATE EMAIL_MAPPING
    SET
        DEL_YN = 'Y',
        DEL_DT = SYSDATE
    WHERE
        EMAIL_CONT_ID = #{emailContId}
    AND
        MAILBOX_ID IN (SELECT MAILBOX_ID FROM EMAIL_BOX WHERE USER_ID = #{userId})
  </update>

<!--
    deleteEmailMappingByEmailContIdAndUserId
      - 특정 사용자(userId)의 특정 이메일(EMAIL_CONT_ID)에 대한 모든 매핑을 물리 삭제. -->
  <delete id="deleteEmailMappingByEmailContIdAndUserId" parameterType="map">
    DELETE FROM EMAIL_MAPPING
    WHERE
        EMAIL_CONT_ID = #{emailContId}
    AND
        MAILBOX_ID IN (SELECT MAILBOX_ID FROM EMAIL_BOX WHERE USER_ID = #{userId})
  </delete>

  <!--
    selectEmailMappingsCountByEmailContId
      - 특정 이메일 콘텐츠를 참조하는 매핑 수 카운트.
      - 컨텐츠(본문/첨부 등) 실제 물리 삭제 여부 판단-->
  <select id="selectEmailMappingsCountByEmailContId" resultType="int" parameterType="string">
    SELECT COUNT(*)
    FROM EMAIL_MAPPING
    WHERE EMAIL_CONT_ID = #{emailContId}
  </select>

<!--
    selectEmailMappingsByMailboxTypeCdAndUserId
      - 사용자(userId) + 메일함 유형 코드(mailboxTypeCd)에 속한 매핑 목록 조회.
      - 보관함 탭(받은/보낸/중요/휴지통 등)별 리스트 출력 -->
  <select id="selectEmailMappingsByMailboxTypeCdAndUserId" resultType="kr.or.ddit.vo.EmailMappingVO" parameterType="map">
    SELECT
        EM.MAILBOX_ID,
        EM.EMAIL_CONT_ID,
        EM.READ_YN,
        EM.READ_DT,
        EM.DEL_YN,
        EM.DEL_DT
    FROM EMAIL_MAPPING EM
    INNER JOIN EMAIL_BOX EB ON EM.MAILBOX_ID = EB.MAILBOX_ID
    WHERE
        EB.USER_ID = #{userId}
    AND
        EB.MAILBOX_TYPE_CD = #{mailboxTypeCd}
  </select>

<!--
    selectEmailMappingByEmailContIdAndUserIdAndMailboxTypeCd
      - 이메일 1건(EMAIL_CONT_ID)에 대해, 특정 사용자(userId)의 특정 유형 메일함(mailboxTypeCd)에 존재하는 매핑 단건 조회. -->
  <select id="selectEmailMappingByEmailContIdAndUserIdAndMailboxTypeCd" resultType="kr.or.ddit.vo.EmailMappingVO" parameterType="map">
    SELECT
        EM.MAILBOX_ID,
        EM.EMAIL_CONT_ID,
        EM.READ_YN,
        EM.READ_DT,
        EM.DEL_YN,
        EM.DEL_DT
    FROM EMAIL_MAPPING EM
    INNER JOIN EMAIL_BOX EB ON EM.MAILBOX_ID = EB.MAILBOX_ID
    WHERE
        EM.EMAIL_CONT_ID = #{emailContId}
    AND
        EB.USER_ID = #{userId}
    AND
        EB.MAILBOX_TYPE_CD = #{mailboxTypeCd}
  </select>

</mapper>
